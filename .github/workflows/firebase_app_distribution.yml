name: Firebase App Distribution

on:
  push:
    branches:
      - feature/firebase-integration # atau branch utama Anda
    workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4' # Tentukan versi Flutter Anda

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Android App Bundle
        run: flutter build apk --release

      # Install Firebase CLI (dijalankan setelah build Flutter)
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Siapkan GOOGLE_APPLICATION_CREDENTIALS dari secret JSON
      - name: Set up Google Application Credentials
        run: |
          # Tulis konten JSON secret ke dalam file lokal
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}" > service_account_key.json
          # Setel variabel lingkungan agar Firebase CLI dapat menemukannya secara otomatis
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/service_account_key.json" >> $GITHUB_ENV
        # Pastikan secret FIREBASE_SERVICE_ACCOUNT_KEY berisi SELURUH konten JSON

      # Dapatkan pesan commit untuk release notes
      - name: Get commit message for release notes
        id: get_commit
        run: echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      # Upload ke Firebase App Distribution menggunakan Firebase CLI
      - name: Upload to Firebase App Distribution
        run: firebase appdistribution:distribute build/app/outputs/flutter-apk/app-release.apk
        with:
          app: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          groups: pbl-jawara
          releaseNotes: ${{ steps.get_commit.outputs.message }}